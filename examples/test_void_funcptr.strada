# test_void_funcptr.strada - Test void-returning struct function pointers
#
# This test validates that struct function pointer fields declared with void
# return type are correctly handled:
# 1. Cast to void(*) instead of StradaValue*(*)
# 2. Not wrapped in expression statement cleanup (which would cause segfault)

# Void-returning callback functions
func on_event() void {
    say("  on_event called");
}

func on_data(int $value) void {
    say("  on_data called with: " . $value);
}

func on_message(str $msg) void {
    say("  on_message called with: " . $msg);
}

func on_pair(int $a, str $b) void {
    say("  on_pair called with: " . $a . ", " . $b);
}

# Struct with void-returning function pointer fields
struct VoidCallbacks {
    func() void no_args;
    func(int) void one_int;
    func(str) void one_str;
    func(int, str) void two_args;
}

# Test calling the void function pointers
func test_void_callbacks(VoidCallbacks $cb) void {
    say("Testing void-returning function pointers...");

    # Call each void function pointer - should not segfault
    $cb->no_args();
    $cb->one_int(42);
    $cb->one_str("hello");
    $cb->two_args(99, "world");

    say("  All void callbacks completed");
}

# Test with multiple calls in sequence
func test_multiple_calls(VoidCallbacks $cb) void {
    say("Testing multiple sequential calls...");

    # Call same function multiple times
    $cb->one_int(1);
    $cb->one_int(2);
    $cb->one_int(3);

    # Interleave different functions
    $cb->no_args();
    $cb->one_str("a");
    $cb->no_args();
    $cb->one_str("b");

    say("  Multiple calls completed");
}

# Test void funcptr calls in conditionals
func test_conditional_calls(VoidCallbacks $cb, int $flag) void {
    say("Testing conditional calls (flag=" . $flag . ")...");

    if ($flag == 1) {
        $cb->no_args();
    } else {
        $cb->one_int(0);
    }

    say("  Conditional call completed");
}

# Test void funcptr calls in loops
func test_loop_calls(VoidCallbacks $cb) void {
    say("Testing calls in loop...");

    for (my int $i = 0; $i < 3; $i++) {
        $cb->one_int($i);
    }

    say("  Loop calls completed");
}

func main() int {
    say("=== Void Function Pointer Test ===");
    say("");

    # Create callback struct
    my VoidCallbacks $cb;
    $cb->no_args = &on_event;
    $cb->one_int = &on_data;
    $cb->one_str = &on_message;
    $cb->two_args = &on_pair;

    # Run all tests
    test_void_callbacks($cb);
    say("");

    test_multiple_calls($cb);
    say("");

    test_conditional_calls($cb, 1);
    test_conditional_calls($cb, 0);
    say("");

    test_loop_calls($cb);
    say("");

    say("PASS: All void function pointer tests completed successfully");
    return 0;
}
