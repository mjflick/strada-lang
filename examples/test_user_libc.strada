func test_getpwuid() int {
    my int $uid = sys::getuid();
    my scalar $pw = sys::getpwuid($uid);
    if (!defined($pw)) {
        say("FAIL: getpwuid(" . $uid . ") failed");
        return 1;
    }
    my str $name = $pw->{"name"};
    if (length($name) == 0) {
        say("FAIL: getpwuid returned empty name");
        return 1;
    }
    my str $dir = $pw->{"dir"};
    if (length($dir) == 0) {
        say("FAIL: getpwuid returned empty dir");
        return 1;
    }
    return 0;
}

func test_getpwnam() int {
    my int $uid = sys::getuid();
    my scalar $pw1 = sys::getpwuid($uid);
    if (!defined($pw1)) {
        return 0;
    }
    my str $name = $pw1->{"name"};
    my scalar $pw2 = sys::getpwnam($name);
    if (!defined($pw2)) {
        say("FAIL: getpwnam(" . $name . ") failed");
        return 1;
    }
    my int $uid2 = $pw2->{"uid"};
    if ($uid != $uid2) {
        say("FAIL: getpwnam returned wrong uid");
        return 1;
    }
    return 0;
}

func test_getgrgid() int {
    my int $gid = sys::getgid();
    my scalar $gr = sys::getgrgid($gid);
    if (!defined($gr)) {
        say("FAIL: getgrgid(" . $gid . ") failed");
        return 1;
    }
    my str $name = $gr->{"name"};
    if (length($name) == 0) {
        say("FAIL: getgrgid returned empty name");
        return 1;
    }
    return 0;
}

func test_getgroups() int {
    my scalar $groups = sys::getgroups();
    if (!defined($groups)) {
        say("FAIL: getgroups() failed");
        return 1;
    }
    return 0;
}

func main() int {
    my int $failed = 0;

    $failed = $failed + test_getpwuid();
    $failed = $failed + test_getpwnam();
    $failed = $failed + test_getgrgid();
    $failed = $failed + test_getgroups();

    if ($failed == 0) {
        say("All user libc tests passed");
    } else {
        say("Failed: " . $failed . " tests");
    }

    return $failed;
}
