/*
 * This file is part of the Strada Language (https://github.com/mjflick/strada-lang).
 * Copyright (c) 2026 Michael J. Flickinger
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 2.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

# test_cstruct.strada - Test C struct support

func test_point() void {
    say("Testing Point struct:");
    
    # Create Point struct (2 ints = 8 bytes)
    my scalar $point = sys::cstruct_new("Point", 8);
    
    # Set x and y
    sys::cstruct_set_int($point, "x", 0, 100);
    sys::cstruct_set_int($point, "y", 4, 200);

    # Read back
    my int $x = sys::cstruct_get_int($point, "x", 0);
    my int $y = sys::cstruct_get_int($point, "y", 4);
    
    say("  Point: (" . $x . ", " . $y . ")");
    
    sys::free($point);
}

func test_rectangle() void {
    say("Testing Rectangle struct:");
    
    # struct Rectangle { int x, y, width, height; }
    my scalar $rect = sys::cstruct_new("Rectangle", 16);

    sys::cstruct_set_int($rect, "x", 0, 10);
    sys::cstruct_set_int($rect, "y", 4, 20);
    sys::cstruct_set_int($rect, "width", 8, 150);
    sys::cstruct_set_int($rect, "height", 12, 100);

    my int $w = sys::cstruct_get_int($rect, "width", 8);
    my int $h = sys::cstruct_get_int($rect, "height", 12);
    my int $area = $w * $h;
    
    say("  Rectangle: " . $w . "x" . $h);
    say("  Area: " . $area);

    sys::free($rect);
}

func test_person() void {
    say("Testing Person struct:");

    # struct Person { char name[64]; int age; double height; }
    # Approximate size with padding
    my scalar $person = sys::cstruct_new("Person", 80);

    sys::cstruct_set_string($person, "name", 0, "Alice");
    sys::cstruct_set_int($person, "age", 64, 30);
    sys::cstruct_set_double($person, "height", 68, 5.6);

    my str $name = sys::cstruct_get_string($person, "name", 0);
    my int $age = sys::cstruct_get_int($person, "age", 64);
    my num $height = sys::cstruct_get_double($person, "height", 68);
    
    say("  Name: " . $name);
    say("  Age: " . $age);
    say("  Height: " . $height);

    sys::free($person);
}

func main() int {
    say("=== C Struct Support Test ===");
    say("");
    
    test_point();
    say("");
    
    test_rectangle();
    say("");
    
    test_person();
    say("");
    
    say("âœ“ All C struct tests passed!");
    
    return 0;
}
