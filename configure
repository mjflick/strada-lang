#!/bin/bash
#
# Strada configure script
# Detects optional dependencies and generates config.mk
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
PREFIX="/usr/local"
CC="${CC:-gcc}"

# Detected features
HAVE_MYSQL=0
HAVE_SQLITE=0
HAVE_POSTGRES=0
HAVE_CRYPT=0
HAVE_READLINE=0
HAVE_SSL=0
HAVE_ZLIB=0
HAVE_LIBUSB=0

# Library flags
MYSQL_CFLAGS=""
MYSQL_LIBS=""
SQLITE_CFLAGS=""
SQLITE_LIBS=""
POSTGRES_CFLAGS=""
POSTGRES_LIBS=""
CRYPT_LIBS=""
READLINE_CFLAGS=""
READLINE_LIBS=""
SSL_CFLAGS=""
SSL_LIBS=""
ZLIB_LIBS=""
LIBUSB_CFLAGS=""
LIBUSB_LIBS=""

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        --prefix=*)
            PREFIX="${1#*=}"
            ;;
        --with-mysql)
            FORCE_MYSQL=1
            ;;
        --without-mysql)
            SKIP_MYSQL=1
            ;;
        --with-sqlite)
            FORCE_SQLITE=1
            ;;
        --without-sqlite)
            SKIP_SQLITE=1
            ;;
        --with-postgres)
            FORCE_POSTGRES=1
            ;;
        --without-postgres)
            SKIP_POSTGRES=1
            ;;
        --help|-h)
            echo "Usage: ./configure [options]"
            echo ""
            echo "Options:"
            echo "  --prefix=PATH       Installation prefix (default: /usr/local)"
            echo "  --with-mysql        Force MySQL support (fail if not found)"
            echo "  --without-mysql     Disable MySQL support"
            echo "  --with-sqlite       Force SQLite support (fail if not found)"
            echo "  --without-sqlite    Disable SQLite support"
            echo "  --with-postgres     Force PostgreSQL support (fail if not found)"
            echo "  --without-postgres  Disable PostgreSQL support"
            echo "  --help, -h          Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
    shift
done

echo "Configuring Strada..."
echo ""

# Helper function to check for a library
check_lib() {
    local name="$1"
    local header="$2"
    local lib="$3"
    local func="$4"

    local tmpfile=$(mktemp)
    local tmpsrc="${tmpfile}.c"
    mv "$tmpfile" "$tmpsrc"

    cat > "$tmpsrc" << EOF
#include <$header>
int main() {
    void *p = (void*)$func;
    return p ? 0 : 1;
}
EOF

    if $CC -o "${tmpfile}.out" "$tmpsrc" -l$lib 2>/dev/null; then
        rm -f "$tmpsrc" "${tmpfile}.out"
        return 0
    else
        rm -f "$tmpsrc" "${tmpfile}.out"
        return 1
    fi
}

# Helper function to check pkg-config
check_pkg() {
    local pkg="$1"
    pkg-config --exists "$pkg" 2>/dev/null
}

# Check for pkg-config
if command -v pkg-config &>/dev/null; then
    HAS_PKGCONFIG=1
else
    HAS_PKGCONFIG=0
    echo -e "${YELLOW}Warning: pkg-config not found, using manual detection${NC}"
fi

echo "Checking for dependencies..."
echo ""

# Check MySQL
if [ "$SKIP_MYSQL" != "1" ]; then
    printf "  Checking for MySQL... "
    if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg mysqlclient; then
        HAVE_MYSQL=1
        MYSQL_CFLAGS="$(pkg-config --cflags mysqlclient)"
        MYSQL_LIBS="$(pkg-config --libs mysqlclient)"
        echo -e "${GREEN}yes${NC} (pkg-config)"
    elif [ "$HAS_PKGCONFIG" = "1" ] && check_pkg mariadb; then
        HAVE_MYSQL=1
        MYSQL_CFLAGS="$(pkg-config --cflags mariadb)"
        MYSQL_LIBS="$(pkg-config --libs mariadb)"
        echo -e "${GREEN}yes${NC} (mariadb pkg-config)"
    elif command -v mysql_config &>/dev/null; then
        HAVE_MYSQL=1
        MYSQL_CFLAGS="$(mysql_config --cflags)"
        MYSQL_LIBS="$(mysql_config --libs)"
        echo -e "${GREEN}yes${NC} (mysql_config)"
    elif check_lib "MySQL" "mysql/mysql.h" "mysqlclient" "mysql_init"; then
        HAVE_MYSQL=1
        MYSQL_LIBS="-lmysqlclient"
        echo -e "${GREEN}yes${NC}"
    else
        echo -e "${RED}no${NC}"
        if [ "$FORCE_MYSQL" = "1" ]; then
            echo "Error: MySQL requested but not found"
            echo "Install with: apt install libmysqlclient-dev"
            exit 1
        fi
    fi
else
    printf "  Checking for MySQL... "
    echo -e "${YELLOW}disabled${NC}"
fi

# Check SQLite
if [ "$SKIP_SQLITE" != "1" ]; then
    printf "  Checking for SQLite... "
    if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg sqlite3; then
        HAVE_SQLITE=1
        SQLITE_CFLAGS="$(pkg-config --cflags sqlite3)"
        SQLITE_LIBS="$(pkg-config --libs sqlite3)"
        echo -e "${GREEN}yes${NC} (pkg-config)"
    elif check_lib "SQLite" "sqlite3.h" "sqlite3" "sqlite3_open"; then
        HAVE_SQLITE=1
        SQLITE_LIBS="-lsqlite3"
        echo -e "${GREEN}yes${NC}"
    else
        echo -e "${RED}no${NC}"
        if [ "$FORCE_SQLITE" = "1" ]; then
            echo "Error: SQLite requested but not found"
            echo "Install with: apt install libsqlite3-dev"
            exit 1
        fi
    fi
else
    printf "  Checking for SQLite... "
    echo -e "${YELLOW}disabled${NC}"
fi

# Check PostgreSQL
if [ "$SKIP_POSTGRES" != "1" ]; then
    printf "  Checking for PostgreSQL... "
    if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg libpq; then
        HAVE_POSTGRES=1
        POSTGRES_CFLAGS="$(pkg-config --cflags libpq)"
        POSTGRES_LIBS="$(pkg-config --libs libpq)"
        echo -e "${GREEN}yes${NC} (pkg-config)"
    elif command -v pg_config &>/dev/null; then
        HAVE_POSTGRES=1
        POSTGRES_CFLAGS="-I$(pg_config --includedir)"
        POSTGRES_LIBS="-L$(pg_config --libdir) -lpq"
        echo -e "${GREEN}yes${NC} (pg_config)"
    elif check_lib "PostgreSQL" "libpq-fe.h" "pq" "PQconnectdb"; then
        HAVE_POSTGRES=1
        POSTGRES_LIBS="-lpq"
        echo -e "${GREEN}yes${NC}"
    else
        echo -e "${RED}no${NC}"
        if [ "$FORCE_POSTGRES" = "1" ]; then
            echo "Error: PostgreSQL requested but not found"
            echo "Install with: apt install libpq-dev"
            exit 1
        fi
    fi
else
    printf "  Checking for PostgreSQL... "
    echo -e "${YELLOW}disabled${NC}"
fi

# Check libcrypt
printf "  Checking for libcrypt... "
if check_lib "crypt" "crypt.h" "crypt" "crypt_r"; then
    HAVE_CRYPT=1
    CRYPT_LIBS="-lcrypt"
    echo -e "${GREEN}yes${NC}"
else
    echo -e "${RED}no${NC}"
fi

# Check readline
printf "  Checking for readline... "
if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg readline; then
    HAVE_READLINE=1
    READLINE_CFLAGS="$(pkg-config --cflags readline)"
    READLINE_LIBS="$(pkg-config --libs readline)"
    echo -e "${GREEN}yes${NC} (pkg-config)"
elif check_lib "readline" "readline/readline.h" "readline" "readline"; then
    HAVE_READLINE=1
    READLINE_LIBS="-lreadline"
    echo -e "${GREEN}yes${NC}"
else
    echo -e "${RED}no${NC}"
fi

# Check OpenSSL
printf "  Checking for OpenSSL... "
if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg openssl; then
    HAVE_SSL=1
    SSL_CFLAGS="$(pkg-config --cflags openssl)"
    SSL_LIBS="$(pkg-config --libs openssl)"
    echo -e "${GREEN}yes${NC} (pkg-config)"
elif check_lib "OpenSSL" "openssl/ssl.h" "ssl" "SSL_new"; then
    HAVE_SSL=1
    SSL_LIBS="-lssl -lcrypto"
    echo -e "${GREEN}yes${NC}"
else
    echo -e "${RED}no${NC}"
fi

# Check zlib
printf "  Checking for zlib... "
if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg zlib; then
    HAVE_ZLIB=1
    ZLIB_LIBS="$(pkg-config --libs zlib)"
    echo -e "${GREEN}yes${NC} (pkg-config)"
elif check_lib "zlib" "zlib.h" "z" "deflate"; then
    HAVE_ZLIB=1
    ZLIB_LIBS="-lz"
    echo -e "${GREEN}yes${NC}"
else
    echo -e "${RED}no${NC}"
fi

# Check libusb
printf "  Checking for libusb... "
if [ "$HAS_PKGCONFIG" = "1" ] && check_pkg libusb-1.0; then
    HAVE_LIBUSB=1
    LIBUSB_CFLAGS="$(pkg-config --cflags libusb-1.0)"
    LIBUSB_LIBS="$(pkg-config --libs libusb-1.0)"
    echo -e "${GREEN}yes${NC} (pkg-config)"
elif check_lib "libusb" "libusb-1.0/libusb.h" "usb-1.0" "libusb_init"; then
    HAVE_LIBUSB=1
    LIBUSB_LIBS="-lusb-1.0"
    echo -e "${GREEN}yes${NC}"
else
    echo -e "${RED}no${NC}"
fi

echo ""

# Generate config.mk
echo "Generating config.mk..."

cat > config.mk << EOF
# Generated by configure script - do not edit
# Run ./configure to regenerate

PREFIX = $PREFIX
CC = $CC

# Database support
HAVE_MYSQL = $HAVE_MYSQL
HAVE_SQLITE = $HAVE_SQLITE
HAVE_POSTGRES = $HAVE_POSTGRES

# Other libraries
HAVE_CRYPT = $HAVE_CRYPT
HAVE_READLINE = $HAVE_READLINE
HAVE_SSL = $HAVE_SSL
HAVE_ZLIB = $HAVE_ZLIB
HAVE_LIBUSB = $HAVE_LIBUSB

# MySQL
MYSQL_CFLAGS = $MYSQL_CFLAGS
MYSQL_LIBS = $MYSQL_LIBS

# SQLite
SQLITE_CFLAGS = $SQLITE_CFLAGS
SQLITE_LIBS = $SQLITE_LIBS

# PostgreSQL
POSTGRES_CFLAGS = $POSTGRES_CFLAGS
POSTGRES_LIBS = $POSTGRES_LIBS

# libcrypt
CRYPT_LIBS = $CRYPT_LIBS

# readline
READLINE_CFLAGS = $READLINE_CFLAGS
READLINE_LIBS = $READLINE_LIBS

# OpenSSL
SSL_CFLAGS = $SSL_CFLAGS
SSL_LIBS = $SSL_LIBS

# zlib
ZLIB_LIBS = $ZLIB_LIBS

# libusb
LIBUSB_CFLAGS = $LIBUSB_CFLAGS
LIBUSB_LIBS = $LIBUSB_LIBS

# Combined DBI flags
DBI_DEFINES =
DBI_LIBS =

ifeq (\$(HAVE_MYSQL),1)
DBI_DEFINES += -DHAVE_MYSQL
DBI_LIBS += \$(MYSQL_LIBS)
endif

ifeq (\$(HAVE_SQLITE),1)
DBI_DEFINES += -DHAVE_SQLITE3
DBI_LIBS += \$(SQLITE_LIBS)
endif

ifeq (\$(HAVE_POSTGRES),1)
DBI_DEFINES += -DHAVE_POSTGRES
DBI_LIBS += \$(POSTGRES_LIBS)
endif
EOF

# Generate config.sh for the strada script
echo "Generating config.sh..."

cat > config.sh << EOF
# Generated by configure script - do not edit
# Run ./configure to regenerate
# Source this file in shell scripts: . ./config.sh

export STRADA_HAVE_MYSQL=$HAVE_MYSQL
export STRADA_HAVE_SQLITE=$HAVE_SQLITE
export STRADA_HAVE_POSTGRES=$HAVE_POSTGRES
export STRADA_HAVE_CRYPT=$HAVE_CRYPT
export STRADA_HAVE_READLINE=$HAVE_READLINE
export STRADA_HAVE_SSL=$HAVE_SSL
export STRADA_HAVE_ZLIB=$HAVE_ZLIB
export STRADA_HAVE_LIBUSB=$HAVE_LIBUSB

export STRADA_MYSQL_CFLAGS="$MYSQL_CFLAGS"
export STRADA_MYSQL_LIBS="$MYSQL_LIBS"
export STRADA_SQLITE_CFLAGS="$SQLITE_CFLAGS"
export STRADA_SQLITE_LIBS="$SQLITE_LIBS"
export STRADA_POSTGRES_CFLAGS="$POSTGRES_CFLAGS"
export STRADA_POSTGRES_LIBS="$POSTGRES_LIBS"
export STRADA_CRYPT_LIBS="$CRYPT_LIBS"
export STRADA_READLINE_CFLAGS="$READLINE_CFLAGS"
export STRADA_READLINE_LIBS="$READLINE_LIBS"
export STRADA_SSL_CFLAGS="$SSL_CFLAGS"
export STRADA_SSL_LIBS="$SSL_LIBS"
export STRADA_ZLIB_LIBS="$ZLIB_LIBS"
export STRADA_LIBUSB_CFLAGS="$LIBUSB_CFLAGS"
export STRADA_LIBUSB_LIBS="$LIBUSB_LIBS"

# Combined DBI flags
STRADA_DBI_DEFINES=""
STRADA_DBI_LIBS=""

if [ "\$STRADA_HAVE_MYSQL" = "1" ]; then
    STRADA_DBI_DEFINES="\$STRADA_DBI_DEFINES -DHAVE_MYSQL"
    STRADA_DBI_LIBS="\$STRADA_DBI_LIBS \$STRADA_MYSQL_LIBS"
fi

if [ "\$STRADA_HAVE_SQLITE" = "1" ]; then
    STRADA_DBI_DEFINES="\$STRADA_DBI_DEFINES -DHAVE_SQLITE3"
    STRADA_DBI_LIBS="\$STRADA_DBI_LIBS \$STRADA_SQLITE_LIBS"
fi

if [ "\$STRADA_HAVE_POSTGRES" = "1" ]; then
    STRADA_DBI_DEFINES="\$STRADA_DBI_DEFINES -DHAVE_POSTGRES"
    STRADA_DBI_LIBS="\$STRADA_DBI_LIBS \$STRADA_POSTGRES_LIBS"
fi

export STRADA_DBI_DEFINES
export STRADA_DBI_LIBS
EOF

echo ""
echo "Configuration complete!"
echo ""
echo "Summary:"
echo "  Installation prefix: $PREFIX"
echo ""
echo "  Database support:"
[ "$HAVE_MYSQL" = "1" ] && echo -e "    MySQL:      ${GREEN}yes${NC}" || echo -e "    MySQL:      ${RED}no${NC}"
[ "$HAVE_SQLITE" = "1" ] && echo -e "    SQLite:     ${GREEN}yes${NC}" || echo -e "    SQLite:     ${RED}no${NC}"
[ "$HAVE_POSTGRES" = "1" ] && echo -e "    PostgreSQL: ${GREEN}yes${NC}" || echo -e "    PostgreSQL: ${RED}no${NC}"
echo ""
echo "  Other libraries:"
[ "$HAVE_CRYPT" = "1" ] && echo -e "    libcrypt:   ${GREEN}yes${NC}" || echo -e "    libcrypt:   ${RED}no${NC}"
[ "$HAVE_READLINE" = "1" ] && echo -e "    readline:   ${GREEN}yes${NC}" || echo -e "    readline:   ${RED}no${NC}"
[ "$HAVE_SSL" = "1" ] && echo -e "    OpenSSL:    ${GREEN}yes${NC}" || echo -e "    OpenSSL:    ${RED}no${NC}"
[ "$HAVE_ZLIB" = "1" ] && echo -e "    zlib:       ${GREEN}yes${NC}" || echo -e "    zlib:       ${RED}no${NC}"
[ "$HAVE_LIBUSB" = "1" ] && echo -e "    libusb:     ${GREEN}yes${NC}" || echo -e "    libusb:     ${RED}no${NC}"
echo ""
echo "Generated files:"
echo "  config.mk  - Include in Makefiles"
echo "  config.sh  - Source in shell scripts"
echo ""
echo "Next steps:"
echo "  make              # Build Strada"
echo "  make install      # Install to $PREFIX"
echo ""
