# t/test_config.strada - Test configuration parser

func test_defaults() int {
    say("Testing defaults...");
    my hash %config = Cannoli::Config::defaults();

    if ($config{"server.port"} ne "8080") {
        say("  FAIL: default port should be 8080");
        return 1;
    }

    if ($config{"server.workers"} ne "5") {
        say("  FAIL: default workers should be 5");
        return 1;
    }

    say("  PASS");
    return 0;
}

func test_get_int() int {
    say("Testing get_int...");
    my hash %config = ();
    $config{"test.value"} = "42";

    my int $val = Cannoli::Config::get_int(%config, "test.value", 0);
    if ($val != 42) {
        say("  FAIL: expected 42, got " . $val);
        return 1;
    }

    my int $default = Cannoli::Config::get_int(%config, "missing", 99);
    if ($default != 99) {
        say("  FAIL: expected default 99, got " . $default);
        return 1;
    }

    say("  PASS");
    return 0;
}

func test_get_bool() int {
    say("Testing get_bool...");
    my hash %config = ();
    $config{"bool.true1"} = "1";
    $config{"bool.true2"} = "true";
    $config{"bool.true3"} = "yes";
    $config{"bool.false1"} = "0";
    $config{"bool.false2"} = "false";
    $config{"bool.false3"} = "no";

    if (Cannoli::Config::get_bool(%config, "bool.true1", 0) != 1) {
        say("  FAIL: '1' should be true");
        return 1;
    }
    if (Cannoli::Config::get_bool(%config, "bool.true2", 0) != 1) {
        say("  FAIL: 'true' should be true");
        return 1;
    }
    if (Cannoli::Config::get_bool(%config, "bool.true3", 0) != 1) {
        say("  FAIL: 'yes' should be true");
        return 1;
    }
    if (Cannoli::Config::get_bool(%config, "bool.false1", 1) != 0) {
        say("  FAIL: '0' should be false");
        return 1;
    }
    if (Cannoli::Config::get_bool(%config, "bool.false2", 1) != 0) {
        say("  FAIL: 'false' should be false");
        return 1;
    }
    if (Cannoli::Config::get_bool(%config, "bool.false3", 1) != 0) {
        say("  FAIL: 'no' should be false");
        return 1;
    }

    say("  PASS");
    return 0;
}

func test_trim() int {
    say("Testing trim...");

    if (Cannoli::Config::trim("  hello  ") ne "hello") {
        say("  FAIL: trim failed on '  hello  '");
        return 1;
    }

    if (Cannoli::Config::trim("\t\ntest\r\n") ne "test") {
        say("  FAIL: trim failed on tabs/newlines");
        return 1;
    }

    if (Cannoli::Config::trim("") ne "") {
        say("  FAIL: trim failed on empty string");
        return 1;
    }

    say("  PASS");
    return 0;
}

func main() int {
    say("=== Cannoli Config Tests ===");
    say("");

    my int $failures = 0;

    $failures = $failures + test_defaults();
    $failures = $failures + test_get_int();
    $failures = $failures + test_get_bool();
    $failures = $failures + test_trim();

    say("");
    if ($failures == 0) {
        say("All config tests passed!");
        return 0;
    } else {
        say("" . $failures . " test(s) failed!");
        return 1;
    }
}
